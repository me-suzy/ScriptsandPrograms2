<?php
session_start();
include_once "./func.php";
include_once "./zip.lib.php";
$dir="./_images".urldecode($_GET["dir"])."/";
$zip = new zipfile();
$adr=Dir($dir);
while ($file=$adr->Read()){
  if (!(($file==".")||($file=="..")||($file=="index.php")||($file=="_info.txt"))){
    if (!StrStr($file,"_thumb.jpg")) $files[]="$file";
  }
}
$adr->Close();
@Sort($files);
$max=SizeOf($files);
$file_info="";
for ($i=0;$i<$max;$i++){
  $filename=$dir . $files[$i];
  if (@is_dir($filename)){
  } else {
    $f=@FOpen($filename,"rb");
    $add_to_zip = @fread ($f, filesize ($filename));
    //echo "Zip<br>$filename (".filesize($filename).")<br>$add_to_zip<hr>";
    @FClose($f);
    $file_info.="$filename - " . Round((FileSize($filename)/1024),2) . " kB, MD5 hash: " . MD5($add_to_zip) . "\r\n";
    $zip->addFile($add_to_zip, "$files[$i]");
   }
}
$info.=$file_info . "\r\n\r\n------------------------------\r\n";
$info.="Generated by phpFotoAlbum 2, powered by PHP ".phpversion()."\r\n";
$zip->addFile($info, "_info.txt");
$zip_name="fotky.zip";
header("Content-Type: application/x-zip");
header("Content-disposition: attachment; filename=$zip_name");
echo $zip->file();
?>