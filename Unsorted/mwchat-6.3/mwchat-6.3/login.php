<?PHP
  require_once("./libs/requires.php"); require_once("./$CONFIG[MWCHAT_Libs]/db_open.php"); if ($Action == "start_login") { if ($JavaScript != "JS_ENABLED") { Error("ERROR_Javascript"); } if ($BROWSER_AGENT == "KONQUEROR") { Error("ERROR_Browser"); } $Username = Clean_Variable($Username, "all"); $Username = Profanity_Check($Username, "exit"); $rgRegistered_SELECT = db_query(Validate(1), $CONN); $szResult = db_numrows($rgRegistered_SELECT); $AskFor = "NONE"; if ($szResult >= "1") { $szDisplayPassword = "true"; $AskFor = "REGISTERED"; } reset($CONFIG[System_Admins]); while (list($szNull, $szAdmins) = each($CONFIG[System_Admins])) { $rgAdmins = explode(":", $szAdmins); $rgAdmins[0] = Clean_Variable("$rgAdmins[0]", "lowercase"); if ($rgAdmins[0] == $Username) { if ($rgAdmins[1] == "") { Error("ERROR_Restricted"); } $szDisplayPassword = "true"; if ($AskFor == "REGISTERED") { $AskFor = "ADMIN-REGISTERED"; } else { $AskFor = "ADMIN"; } } } reset($CONFIG[System_Operators]); while (list($szNull, $szOps) = each($CONFIG[System_Operators])) { $rgOps = explode(":", $szOps); $rgOps[0] = Clean_Variable("$rgOps[0]", "lowercase"); if ($rgOps[0] == $Username) { if ($rgOps[1] == "") { Error("ERROR_Restricted"); } $szDisplayPassword = "true"; if ($AskFor == "REGISTERED") { $AskFor = "OPERATOR-REGISTERED"; } elseif ($AskFor == "ADMIN-REGISTERED") { $AskFor = "OPERATOR-REGISTERED-ADMIN"; } elseif ($AskFor == "ADMIN") { $AskFor = "ADMIN-OPERATOR"; } else { $AskFor = "OPERATOR"; } } } if ($szDisplayPassword == "true") { $STATUS[Focus] = "Login.Password"; require_once("$CONFIG[MWCHAT_Libs]/header.php"); echo "     <H2>\n"; echo "       $LOCALE[LOGIN_Title]\n"; echo "     </H2>\n"; echo "    <FORM AUTOCOMPLETE=\"OFF\" ACTION=\"login.php\" NAME=Login METHOD=POST>\n"; echo "     <BR>\n"; echo "     <TABLE>\n"; echo "      <TR>\n"; echo "       <TD>\n"; echo "        <FONT COLOR=\"$CONFIG[Color_Foreground]\">\n"; echo "          <B>$LOCALE[LOGIN_Password]</B> (" . HelpLink('Password') . "):\n"; echo "        </FONT COLOR>\n"; echo "       </TD>\n"; echo "       <TD>\n"; echo "        <INPUT TYPE=PASSWORD TABINDEX=1 NAME=Password SIZE=21>\n"; echo "       </TD>\n"; echo "      </TR>\n"; echo "      <TR ALIGN=CENTER>\n"; echo "       <TD COLSPAN=2>\n"; echo "        <INPUT TYPE=SUBMIT TABINDEX=2 VALUE=\"$LOCALE[COMMON_Login_Button]\">\n"; echo "       </TD>\n"; echo "      </TR>\n"; echo "     </TABLE>\n"; echo "      <INPUT TYPE=HIDDEN NAME=\"Action\" VALUE=\"verify_login\">\n"; echo "      <INPUT TYPE=HIDDEN NAME=\"Username\" VALUE=\"$Username\">\n"; if ($CONFIG[Locales] == "true") { echo "      <INPUT TYPE=HIDDEN NAME=\"Lang\" VALUE=\"$Lang\">\n"; } echo "      <INPUT TYPE=HIDDEN NAME=\"AskFor\" VALUE=\"$AskFor\">\n"; echo "      <INPUT TYPE=HIDDEN NAME=\"Resolution\" VALUE=\"$Resolution\">\n"; echo "    </FORM>\n"; require_once("$CONFIG[MWCHAT_Libs]/footer.php"); } else { require_once("$CONFIG[MWCHAT_Libs]/start_lobby.php"); exit; } } elseif ($Action == "verify_login") { if (preg_match("/REGISTERED/", $AskFor)) { $STATUS[Registered] = "yes"; } if (preg_match("/ADMIN/", $AskFor)) { reset($CONFIG[System_Admins]); while (list($szNull, $szAdmins) = each($CONFIG[System_Admins])) { $rgAdmins = explode(":", $szAdmins); $rgAdmins[0] = Clean_Variable("$rgAdmins[0]", "lowercase"); if ($rgAdmins[0] == $Username) { if ($rgAdmins[1] == "") { Error("ERROR_RestrictedName"); } if ($rgAdmins[1] == "$Password") { $STATUS[Admin] = "yes"; require_once("$CONFIG[MWCHAT_Libs]/start_lobby.php"); exit; } } } } elseif (preg_match("/OPERATOR/", $AskFor)) { reset($CONFIG[System_Operators]); while (list($szNull, $szOps) = each($CONFIG[System_Operators])) { $rgOps = explode(":", $szOps); $rgOps[0] = Clean_Variable("$rgOps[0]", "lowercase"); if ($rgOps[0] == $Username) { if ($rgOps[1] == "") { Error("ERROR_RestrictedName"); } if ($rgOps[1] == "$Password") { $STATUS[Operator] = "yes"; require_once("$CONFIG[MWCHAT_Libs]/start_lobby.php"); exit; } } } } else { $rgRegistered_SELECT = db_query(Validate(2), $CONN); while($rgUsers = db_fetch($rgRegistered_SELECT)) { if (base64_decode(rawurldecode($rgUsers[password])) == $Password) { $STATUS[Registered] = "yes"; require_once("$CONFIG[MWCHAT_Libs]/start_lobby.php"); exit; } } } Error("ERROR_BadPass"); } ?>
