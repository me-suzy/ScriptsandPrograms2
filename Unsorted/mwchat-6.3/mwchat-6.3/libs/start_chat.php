<?PHP
  if ($NewPublic != "") { $STATUS[GoRoom] = $NewPublic; $STATUS[GoPrivate] = "no"; } elseif ($NewPrivate != "") { $STATUS[GoRoom] = $NewPrivate; $STATUS[GoPrivate] = "yes"; $STATUS[PrivatePass] = $NewPrivatePass; } elseif ($RoomPublic != "") { $STATUS[GoRoom] = $RoomPublic; $STATUS[GoPrivate] = "no"; } elseif ($RoomPrivate != "") { $STATUS[GoRoom] = $RoomPrivate; $STATUS[GoPrivate] = "yes"; $STATUS[PrivatePass] = $NewPrivatePass; } $STATUS[GoRoom] = Clean_Variable($STATUS[GoRoom], "all"); $STATUS[GoRoom] = Profanity_Check($STATUS[GoRoom], "exit"); if (strlen($STATUS[GoRoom]) > "17") { Error("ERROR_RoomLong"); } $rgRooms_SELECT = db_query(Validate(22), $CONN); $szRoom_Exists = db_numrows($rgRooms_SELECT); if ($STATUS[Admin] == "yes") { $szRoomPasswordCorrect = "yes"; } if ($szRoom_Exists == "0") { reset($CONFIG[Room_Defaults]); while (list($szNull, $szRoom) = each($CONFIG[Room_Defaults])) { $rgRoomPart = explode(":", $szRoom); $rgRoomPart[0] = Clean_Variable($rgRoomPart[0], "all"); $rgRoomPart[0] = Profanity_Check($rgRoomPart[0], "clean"); if ($rgRoomPart[0] == $STATUS[GoRoom]) { if (!empty($rgRoomPart[1])) $LOCALE[COMMON_Topic] = $rgRoomPart[1]; } } $rgRooms_INSERT = db_query("INSERT INTO chat_rooms VALUES(NULL, '$STATUS[GoRoom]', '$LOCALE[COMMON_Topic]', '$STATUS[GoPrivate]', '$STATUS[PrivatePass]')", $CONN); $szRoomPasswordCorrect = "yes"; } else { if ($STATUS[GoPrivate] == "yes") { while($rgRoomInfo = db_fetch($rgRooms_SELECT)) { if ($STATUS[PrivatePass] == $rgRoomInfo[private_pass]) { $szRoomPasswordCorrect = "yes"; } } } else { $szRoomPasswordCorrect = "yes"; } } $rgUsers_SELECT = db_query(Validate(23), $CONN); $szNum_Of_Users_Room = db_numrows($rgUsers_SELECT); if ($szNum_Of_Users_Room < $CONFIG[Room_Visitors] and $szRoomPasswordCorrect == "yes") { if ($STATUS[Registered] == "yes") { if (!empty($STATUS[RegText])) { $rgLobby_UPDATE = db_query("UPDATE chat_lobby SET text_color='$STATUS[RegText]' WHERE username='$Username'", $CONN); } if (!empty($STATUS[message_enter])) { $szEnterMsg = "- ($STATUS[message_enter])"; } } if ($STATUS[Admin] == "yes") { $STATUS[Operator] = "yes"; } if ($szNum_Of_Users_Room == "0" and $CONFIG[Chat_Operator] == "true") { $STATUS[Operator] = "yes"; } if ($STATUS[Operator] != "yes") { reset($CONFIG[System_Operators]); while (list($szNull, $szOps) = each($CONFIG[System_Operators])) { $rgOps = explode(":", $szOps); $rgOps[0] = Clean_Variable("$rgOps[0]", "lowercase"); if ($rgOps[0] == $Username) { if ($rgOps[1] == "") { Error("ERROR_RestrictedName"); } $STATUS[Operator] = "yes"; } } } $rgProcess_DELETE = db_query(Validate(24), $CONN); $rgText_DELETE = db_query(Validate(25), $CONN); $rgUsers_DELETE = db_query(Validate(26), $CONN); $rgUsers_INSERT = db_query("INSERT INTO chat_users VALUES(NULL, '$Username', '$STATUS[GoRoom]', '$STATUS[Operator]', 'no', 'no')", $CONN); while($rgProcesses = db_fetch($rgUsers_SELECT)) { $rgProcess_INSERT = db_query("INSERT INTO chat_process VALUES(NULL, '$rgProcesses[username]', 'reload-all', NULL)", $CONN); } $rgBuddy_SELECT = db_query(Validate(20), $CONN); while ($rgBuddies = db_fetch($rgBuddy_SELECT)) { $rgProcess_INSERT = db_query("INSERT INTO chat_process VALUES(NULL, '$rgBuddies[username]', 'reload-all', NULL)", $CONN); } Post_System("$Username $LOCALE[LOBBY_Entered_Room] $szEnterMsg", "local", $STATUS[GoRoom]); if ($STATUS[Operator] == "yes") { Post_System("$Username $LOCALE[COMMON_Operator]", "local", $STATUS[GoRoom]); } $rgProcess_INSERT = db_query(Validate(27), $CONN); ChatLog("$LOCALE[LOBBY_Entered_Room] - $STATUS[GoRoom]"); db_close($CONN); header("Location: chat.php?Username=$Username&Sequence_Check=$Sequence_Check&Lang=$Lang&Resolution=$Resolution&Room=$STATUS[GoRoom]"); exit; } else { if ($szRoomPasswordCorrect != "yes") { $STATUS[Lobby_Error] = $LOCALE[LOBBY_Password_Incorrect]; } else { $STATUS[Lobby_Error] = $LOCALE[LOBBY_Room_Full]; } } ?>
