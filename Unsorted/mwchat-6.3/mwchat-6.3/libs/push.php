<?PHP
  flush(); $CONFIG[Chat_Window_Timeout] = "60"; $szCompletedQueries = "0"; while($szCompletedQueries < $CONFIG[Chat_Window_Timeout]) { include("$CONFIG[MWCHAT_Libs]/process_task.php"); $rgText_SELECT = db_query("SELECT * FROM chat_text WHERE to_username='$Username' AND room='$Room' AND id > '$szLastMsg' ORDER BY id", $CONN); while($rgTexts = db_fetch($rgText_SELECT)) { if (preg_match("/\*$rgTexts[from_username]\*/", $STATUS[Ignored])) { continue; } $rgChatMsg = Encryption("decode", $rgTexts[message], $Username, $rgTexts[encrypt_vector]); include("$CONFIG[MWCHAT_Libs]/generate_from.php"); echo "$szMessageLine\n"; $szLastMsg = $rgTexts[id]; } if ($CONFIG[Chat_Operator] == "true") { $rgUsers_SELECT = db_query(Validate(5), $CONN); $szActiveOperators = db_numrows($rgUsers_SELECT); if ($szActiveOperators == "0") { $rgUsers_SELECT = db_query(Validate(6), $CONN); while($rgOperators = db_fetch($rgUsers_SELECT)) { $rgUsers_UPDATE = db_query("UPDATE chat_users SET operator='yes' WHERE id='$rgOperators[id]'", $CONN); Post_System("$rgOperators[username] $LOCALE[COMMON_Operator]", "local", $Room); break; } } } if ($STATUS[Registered] == "yes" and $STATUS[Away] == "yes") { Update_TimeStamp($Username); } echo "    <SCRIPT LANGUAGE=\"JavaScript\" TYPE=\"text/JavaScript\">\n"; echo "      <!--\n"; echo "         scrolldown();\n"; echo "      //-->\n"; echo "    </SCRIPT>\n"; flush(); if ($szCompletedQueries > "0") { sleep(3); } $szCompletedQueries++; } echo "    <SCRIPT LANGUAGE=\"JavaScript\" TYPE=\"text/JavaScript\">\n"; echo "      <!--\n"; echo "         window.location.reload();\n"; echo "      //-->\n"; echo "    </SCRIPT>\n"; ?>
