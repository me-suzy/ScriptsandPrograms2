<?PHP
  require_once("./libs/requires.php"); require_once("$CONFIG[MWCHAT_Libs]/security.php"); TimeStamp($Username); $STATUS[Silentheader] = "true"; if ($Action != "GO" and $STATUS[Registered] == "yes" and $CONFIG[Chat_Upload] == "true") { $STATUS[Focus] = "Upload.FileName"; } require_once("$CONFIG[MWCHAT_Libs]/header.php"); echo "  <H2>\n"; echo "    $LOCALE[UPLOAD_Title]\n"; echo "  </H2>\n"; echo "  <HR>\n"; echo "  </CENTER>\n"; if ($CONFIG[Chat_Upload] != "true") { $STATUS[Registered] = "no"; } if ($STATUS[Registered] == "yes") { if ($Action == "GO") { $UploadUser = Clean_Variable($UploadUser, "html"); $UploadUser = Clean_Variable($UploadUser, "spaces"); $UploadUser = Clean_Variable($UploadUser, "lowercase"); if (empty($UploadUser)) { unset($FileName); } if (!is_uploaded_file($FileName) ) { $LOCALE[UPLOAD_Info] = $LOCALE[UPLOAD_Err_Large]; $Action = "NO"; } else { $rgUsers_SELECT = db_query(Validate(7), $CONN); while($rgUsers = db_fetch($rgUsers_SELECT)) { $rgChecks[$rgUsers[username]] = $rgUsers[username]; } $rgRegistered_SELECT = db_query(Validate(1002), $CONN); while($rgList = db_fetch($rgRegistered_SELECT)) { if ($Username != $rgList[username] and $rgChecks[$rgList[username]] == $rgList[username]) { if (!preg_match("/\*$rgList[username]\*/", $rgList[ignored_users])) { $rgOkSendUsers[$rgList[username]] = $rgList[username]; } } } $Action = "NO"; if ($rgOkSendUsers[$UploadUser] != $UploadUser) { $LOCALE[UPLOAD_Info] = $LOCALE[UPLOAD_Err_Accept]; unlink($FileName); } elseif (empty($UploadUser) or file_exists("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser/$FileName_name")) { $LOCALE[UPLOAD_Info] = $LOCALE[UPLOAD_Err_Exists]; unlink($FileName); } else { if (!is_dir("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser")) { mkdir("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser", 0777); chmod("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser", 0777); } $hFiles = opendir("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser"); $szUsedSpace = "0"; while($szFileName = readdir($hFiles)) { if ($szFileName != "." && $szFileName != ".." && $szFileName != "index.php") { clearstatcache(); $rgFileInfo = stat("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser/$szFileName"); $szUsedSpace = ($rgFileInfo[size] + $szUsedSpace); } } closedir($hFiles); clearstatcache(); $rgFileInfo = stat($FileName); $szUsedSpace = ($szUsedSpace + $rgFileInfo[size]); if ($szUsedSpace > $CONFIG[Chat_Upload_Limit]) { $LOCALE[UPLOAD_Info] = $LOCALE[UPLOAD_Err_Full]; unlink($FileName); } else { move_uploaded_file($FileName, "$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser/$Username----$FileName_name"); chmod("$CONFIG[System_Root]/$CONFIG[MWCHAT_Upload]/$UploadUser/$Username----$FileName_name", 0644); Post_Private($UploadUser, "$LOCALE[UPLOAD_Sent_File]: $FileName_name"); ChatLog("$LOCALE[UPLOAD_Sent_File] $FileName_name - $UploadUser"); $LOCALE[UPLOAD_Info] = $LOCALE[UPLOAD_Complete] . " - ($FileName_name)"; } } } } if ($Action != "GO") { echo "  <FORM NAME=Upload ENCTYPE=\"multipart/form-data\" ACTION=\"upload.php?Action=GO\" AUTOCOMPLETE=\"OFF\" METHOD=POST>\n"; echo "  <INPUT TYPE=HIDDEN NAME=Username VALUE=\"$Username\">\n"; echo "  <INPUT TYPE=HIDDEN NAME=Lang VALUE=\"$Lang\">\n"; echo "  <INPUT TYPE=HIDDEN NAME=Room VALUE=\"$Room\">\n"; echo "  <INPUT TYPE=HIDDEN NAME=Resolution VALUE=\"$Resolution\">\n"; echo "  <INPUT TYPE=HIDDEN NAME=Sequence_Check VALUE=\"$Sequence_Check\">\n"; echo "  <INPUT TYPE=HIDDEN NAME=MAX_FILE_SIZE VALUE=\"100000000\">\n"; echo "  $LOCALE[UPLOAD_Info]<BR>\n"; echo "  <TABLE BORDER=0>\n"; echo "   <TR>\n"; echo "     <TD COLSPAN=2>\n"; echo "        <FONT COLOR=\"$CONFIG[Color_Foreground]\"><B>$LOCALE[UPLOAD_File_Send]</B> (" . HelpLink('Upload_File') . "):</FONT COLOR><BR>\n"; echo "        <INPUT TYPE=FILE NAME=FileName TABINDEX=1 MAXLENGTH=100 VALUE=\"$FileName\" SIZE=21>\n"; echo "     </TD>\n"; echo "   </TR>\n"; echo "   <TR>\n"; echo "     <TD>\n"; echo "        <FONT COLOR=\"$CONFIG[Color_Foreground]\"><B>$LOCALE[UPLOAD_User_Send]</B> (" . HelpLink('Upload_User') . "):</FONT COLOR><BR>\n"; echo "        <INPUT TYPE='TEXT' NAME=\"UploadUser\" MAXLENGTH='30' TABINDEX=2 VALUE='$UploadUser'>\n"; echo "     </TD>\n"; echo "     <TD>\n"; echo "        <BR> &nbsp;<INPUT TYPE=SUBMIT VALUE=\"$LOCALE[UPLOAD_Button]\" TABINDEX=3>\n"; echo "     </TD>\n"; echo "   </TR>\n"; echo "  </TABLE>\n"; } echo "  <CENTER>\n"; } else { echo "  <BR><BR><CENTER><B>/upload $LOCALE[COMMON_Registered_Only] </B></CENTER><BR><BR><BR><BR>\n"; } echo "  <HR><CENTER><A HREF=\"#\" onClick=\"self.close()\">$LOCALE[COMMON_Click_Close]</A></CENTER>\n"; require_once("$CONFIG[MWCHAT_Libs]/footer.php"); ?>
