<?php
//Traffic-Drive CJ/TGP v5.14 free, index.php
ignore_user_abort(true);include("vars.php");$link=mysql_connect($hst,$usr,$psw);mysql_select_db($db);$t=time();$hr=date("G");if($HTTP_REFERER){$url=parse_url(strtolower($HTTP_REFERER));if (substr($url["host"],0,4)=="www.")$from=substr($url["host"],4);else $from=$url["host"];}if(!$from)$from='nourl';else $from=addslashes($from);$q="select d,fpr from tr where d='$from'";$r=mysql_query($q);if(mysql_num_rows($r)==0){$from="nourl";$fpr="";}else{$s=mysql_fetch_array($r);$fpr=$s["fpr"];}if(($rlog==1)and($HTTP_REFERER)){$q1=addslashes($HTTP_REFERER);$q="update rf set rin=rin+1 where d='$from' and rurl='$q1' and hr='$hr'";$r=mysql_query($q);if(mysql_affected_rows($link)==0){$q="insert into rf values('$from','$q1','$hr','1')";$r=mysql_query($q);}}if($REMOTE_ADDR)$ipfrom=$REMOTE_ADDR;else $ipfrom="0";$q="select sf from ipfrom where ip='$ipfrom' order by tm desc";$r=mysql_query($q);if(mysql_num_rows($r)==0){$unin=1;$sf=1;}else{$unin=0;$s=mysql_fetch_array($r);$sf=$s["sf"]+1;if(!file_exists($fpr.$sf.".".$iext))$sf=1;}$q="insert into ipfrom values ('$ipfrom','$from','$t','$sf')";$r=mysql_query($q);$huf=0;$q="select lu,lh from sts where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);$s=mysql_fetch_array($r);if($hr==0)$hrl=23;else $hrl=$hr-1;if($hr!=$s["lh"]){if($hr==23)$hu=0;else $hu=$hr+1;$q="update sts set lh=$hr,lu=$t where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);$huf=1;$rin=0;$uin=0;$cl=0;$gcl=0;$out=0;$topmemb=0;$toptpl=join('',file("toptpl.txt"));$fp=fopen("top.txt","w");$q="select hr.rin0+hr.rin1+hr.rin2+hr.rin3+hr.rin4+hr.rin5+hr.rin6+hr.rin7+hr.rin8+hr.rin9+hr.rin10+hr.rin11+hr.rin12+hr.rin13+hr.rin14+hr.rin15+hr.rin16+hr.rin17+hr.rin18+hr.rin19+hr.rin20+hr.rin21+hr.rin22+hr.rin23 as drin,hr.uin0+hr.uin1+hr.uin2+hr.uin3+hr.uin4+hr.uin5+hr.uin6+hr.uin7+hr.uin8+hr.uin9+hr.uin10+hr.uin11+hr.uin12+hr.uin13+hr.uin14+hr.uin15+hr.uin16+hr.uin17+hr.uin18+hr.uin19+hr.uin20+hr.uin21+hr.uin22+hr.uin23 as duin,hr.cl0+hr.cl1+hr.cl2+hr.cl3+hr.cl4+hr.cl5+hr.cl6+hr.cl7+hr.cl8+hr.cl9+hr.cl10+hr.cl11+hr.cl12+hr.cl13+hr.cl14+hr.cl15+hr.cl16+hr.cl17+hr.cl18+hr.cl19+hr.cl20+hr.cl21+hr.cl22+hr.cl23 as dcl,hr.gcl0+hr.gcl1+hr.gcl2+hr.gcl3+hr.gcl4+hr.gcl5+hr.gcl6+hr.gcl7+hr.gcl8+hr.gcl9+hr.gcl10+hr.gcl11+hr.gcl12+hr.gcl13+hr.gcl14+hr.gcl15+hr.gcl16+hr.gcl17+hr.gcl18+hr.gcl19+hr.gcl20+hr.gcl21+hr.gcl22+hr.gcl23 as dgcl,hr.out0+hr.out1+hr.out2+hr.out3+hr.out4+hr.out5+hr.out6+hr.out7+hr.out8+hr.out9+hr.out10+hr.out11+hr.out12+hr.out13+hr.out14+hr.out15+hr.out16+hr.out17+hr.out18+hr.out19+hr.out20+hr.out21+hr.out22+hr.out23 as dout,hr.d as d,hr.rin$hrl as rin,hr.uin$hrl as uin,hr.cl$hrl as cl,hr.gcl$hrl as gcl,hr.out$hrl as out,hr.f$hr as f,hr.a$hr as a,tr.tl as tl,tr.r as r,tr.t as t,tr.tr as tr,tr.otr as otr,tr.htr as htr,tr.hotr as hotr,tr.itl as itl from hr,tr where hr.d=tr.d order by ";switch($toporder){case "rin":$qord="rin desc";break;case "uin":$qord="uin desc";break;case "cl":$qord="cl desc";break;case "gcl":$qord="gcl desc";break;case "drin":$qord="drin desc";break;case "duin":$qord="duin desc";break;case "dcl":$qord="dcl desc";break;case "dgcl":$qord="dgcl desc";break;default:$qord="uin desc";}$q=$q.$qord;$r=mysql_query($q);while($row=mysql_fetch_array($r)){$d=$row["d"];$hf=$row["f"];$drin=$row["drin"];$duin=$row["duin"];$dcl=$row["dcl"];$dgcl=$row["dgcl"];$dout=$row["dout"];$rin=$rin+$drin;$uin=$uin+$duin;$cl=$cl+$dcl;$gcl=$gcl+$dgcl;$out=$out+$dout;if(($topmemb<$topmax)and($row["itl"]!='0')){$topmemb=$topmemb+1;$topstr=str_replace("%num%",$topmemb,$toptpl);$topstr=str_replace("%name%",$row["tl"],$topstr);$topstr=str_replace("%dom%",$d,$topstr);$topstr=str_replace("%rin%",$row["rin"],$topstr);$topstr=str_replace("%uin%",$row["uin"],$topstr);$topstr=str_replace("%cl%",$row["cl"],$topstr);$topstr=str_replace("%gcl%",$row["gcl"],$topstr);$topstr=str_replace("%out%",$row["out"],$topstr);$topstr=str_replace("%drin%",$row["drin"],$topstr);$topstr=str_replace("%duin%",$row["duin"],$topstr);$topstr=str_replace("%dcl%",$row["dcl"],$topstr);$topstr=str_replace("%dgcl%",$row["dgcl"],$topstr);$topstr=str_replace("%dout%",$row["dout"],$topstr);fwrite($fp,$topstr);if(file_exists("topbr".$topmemb.".txt")){$topbr=join('',file("topbr".$topmemb.".txt"));fwrite($fp,$topbr);}}switch($row["t"]){case "c":$dowed=ceil($dcl*$row["r"]/100-$dout);break;case "r":$dowed=ceil($drin*$row["r"]/100-$dout);break;case "u":$dowed=ceil($duin*$row["r"]/100-$dout);break;case "f":$dowed=0;break;default:$dowed=ceil(($drin+$dcl)*$row["r"]/200-$dout);}$owed=$dowed+$hf;if(($row["tr"]>$drin)or(($row["otr"]>0)and($row["otr"]<($dout-$drin)))or($row["htr"]>$rin)or(($row["hotr"]>0)and($row["hotr"]<($out-$rin))))$a=0;else $a=$row["a"];$q1="update tr set dowed='$dowed',owed='$owed',a='$a',hf='$hf',drin='$drin',duin='$duin',dcl='$dcl',dgcl='$dgcl',dout='$dout',etr='1' where d='$d'";$r1=mysql_query($q1);}fwrite($fp,"<br>powered by <a href=http://www.traffic-drive.com/scripts>Traffic-Drive</a>");fclose($fp);$q="update hr set rin$hu='0',uin$hu='0',cl$hu='0',gcl$hu='0',out$hu='0'";$r=mysql_query($q);$q="delete from gal where hr='$hu'";$r=mysql_query($q);$q="delete from rf where hr='$hu'";$r=mysql_query($q);if($rin>0)$pr=ceil($cl/$rin*100);else $pr=0;$q="update sts set rin='$rin',uin='$uin',cl='$cl',gcl='$gcl',out='$out',pr='$pr',hrin='0',huin='0',hcl='0',hgcl='0',hout='0',hpr='0' where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);$deltm=$t-$ript;$q="delete from ipfrom where tm<$deltm";$r=mysql_query($q);$q="delete from ipto where tm<$deltm";$r=mysql_query($q);}if($unin==1){$q="update hr set rin$hr=rin$hr+1,uin$hr=uin$hr+1 where d='$from'";$r=mysql_query($q);$q="update tr set rin=rin+1,uin=uin+1 where d='$from'";$r=mysql_query($q);$q="update sts set hrin=hrin+1,huin=huin+1 where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);}else{$q="update hr set rin$hr=rin$hr+1 where d='$from'";$r=mysql_query($q);$q="update tr set rin=rin+1 where d='$from'";$r=mysql_query($q);$q="update sts set hrin=hrin+1 where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);}if((abs($t-$s["lu"])>$rt)and($huf==0)){$q="update sts set lu=$t where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);$rin=0;$cl=0;$q="select hr.rin$hr as rin,hr.uin$hr as uin,hr.cl$hr as cl,hr.out$hr as out,hr.f$hr as f,hr.a$hr as a,hr.rin$hrl as rinhrl,hr.out$hrl as outhrl,hr.d as d,tr.r as r,tr.t as t,tr.tr as tr,tr.otr as otr,tr.htr as htr,tr.hotr as hotr,tr.dowed as dowed,tr.a as ca,tr.drin as drin,tr.dout as dout,tr.etr as etr from hr,tr where hr.d=tr.d";$r=mysql_query($q);while($row=mysql_fetch_array($r)){$d=$row["d"];switch($row["t"]){case "c":$owed=$row["dowed"]+ceil($row["cl"]*$row["r"]/100)+$row["f"]-$row["out"];break;case "r":$owed=$row["dowed"]+ceil($row["rin"]*$row["r"]/100)+$row["f"]-$row["out"];break;case "u":$owed=$row["dowed"]+ceil($row["uin"]*$row["r"]/100)+$row["f"]-$row["out"];break;case "f":$owed=$row["f"]-$row["out"];break;default:$owed=$row["dowed"]+ceil(($row["rin"]+$row["cl"])*$row["r"]/200)+$row["f"]-$row["out"];}if($row["etr"]=='1'){$drin=$row["drin"]+$row["rin"];$dout=$row["dout"]+$row["out"];if(($row["tr"]>$drin)or(($row["otr"]>0)and($row["otr"]<($dout-$drin)))or($row["htr"]>$row["rinhrl"])or(($row["hotr"]>0)and($row["hotr"]<($row["outhrl"]-$row["rinhrl"]))))$a=0;else $a=$row["a"];}else $a=$row["ca"];$q1="update tr set owed='$owed',a='$a' where d='$d'";$r1=mysql_query($q1);$rin=$rin+$row["rin"];$cl=$cl+$row["cl"];}if($rin>0)$pr=ceil($cl/$rin*100);else $pr=0;$q="update sts set hpr='$pr' where k='aHR0cDovL3d3dy5hbGxtYXh4eC5jb20vZnJlZQ=='";$r=mysql_query($q);}mysql_close($link);if($itype==1){if(file_exists($fpr.$sf.".".$iext))header("Location: ".$ipref.$fpr.$sf.".".$iext);}else{if(file_exists($fpr.$sf.".".$iext))include($fpr.$sf.".".$iext);}
?>