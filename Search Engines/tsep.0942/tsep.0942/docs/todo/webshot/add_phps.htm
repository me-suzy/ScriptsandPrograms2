http://kicken.mine.nu:8008/extras/webshot/add.php

<code><font color="#000000">
<font color="#0000BB">&lt;?php<br /></font><font color="#FF8000">/************************************************<br /> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Screen Capture script&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;Written by: Keith (aka kicken)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;Email: keithm@aoeex.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;What's it do?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;This script takes a URL and creates a &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *graphic of the url that can be displayed.&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;How's it do that?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *&nbsp;&nbsp;&nbsp;&nbsp;It's quite simple, but does require a &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *few things.&nbsp;&nbsp;First, you need some sort of a &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *web browser that can be called up with a &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *defualt URL on the command line and supports&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *javascript.&nbsp;&nbsp;Second, you need to have &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *Imagemagick (specifically the import&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> *command).&nbsp;&nbsp;This is used to take a screen &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *capture a few seconds after the web browser &nbsp;&nbsp;&nbsp;&nbsp;*<br /> *has been launched.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /> ************************************************/<br /><br /></font><font color="#0000BB">$path_to_browser</font><font color="#007700">=</font><font color="#DD0000">'/usr/local/bin/mozilla'</font><font color="#007700">;<br /></font><font color="#0000BB">$path_to_import</font><font color="#007700">=</font><font color="#DD0000">'/usr/X11R6/bin/import'</font><font color="#007700">;<br /></font><font color="#0000BB">$path_to_output</font><font color="#007700">=</font><font color="#DD0000">'/home/kicken/gimp/ss'</font><font color="#007700">;<br /></font><font color="#0000BB">$path_to_redirect</font><font color="#007700">=</font><font color="#DD0000">'file:///home/kicken/programming/PHP/ss.html'</font><font color="#007700">;<br /></font><font color="#0000BB">$crop</font><font color="#007700">=</font><font color="#DD0000">'1008x622+0+126'</font><font color="#007700">;<br /></font><font color="#0000BB">$format</font><font color="#007700">=</font><font color="#DD0000">'.jpg'</font><font color="#007700">;<br /></font><font color="#0000BB">$quality</font><font color="#007700">=</font><font color="#0000BB">60</font><font color="#007700">;<br /></font><font color="#0000BB">$timeout</font><font color="#007700">=</font><font color="#0000BB">60</font><font color="#007700">;<br /><br /></font><font color="#FF8000">//// Stop Editing Here!!!!!! //////<br /><br /><br /></font><font color="#007700">function </font><font color="#0000BB">valid_url</font><font color="#007700">(</font><font color="#0000BB">$url</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;if (</font><font color="#0000BB">substr</font><font color="#007700">(</font><font color="#0000BB">$url</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">, </font><font color="#0000BB">7</font><font color="#007700">) != </font><font color="#DD0000">'http://'</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return </font><font color="#0000BB">false</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$parts</font><font color="#007700">=</font><font color="#0000BB">parse_url</font><font color="#007700">(</font><font color="#0000BB">$url</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if (!isset(</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'port'</font><font color="#007700">])){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'port'</font><font color="#007700">]=</font><font color="#0000BB">80</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if (!isset(</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'query'</font><font color="#007700">])){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'query'</font><font color="#007700">]=</font><font color="#DD0000">''</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'query'</font><font color="#007700">]=</font><font color="#DD0000">'?'</font><font color="#007700">.</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'query'</font><font color="#007700">];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$fs</font><font color="#007700">=@</font><font color="#0000BB">fsockopen</font><font color="#007700">(</font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'host'</font><font color="#007700">], </font><font color="#0000BB">$parts</font><font color="#007700">[</font><font color="#DD0000">'port'</font><font color="#007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;if (!</font><font color="#0000BB">$fs</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return </font><font color="#0000BB">false</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">fputs</font><font color="#007700">(</font><font color="#0000BB">$fs</font><font color="#007700">, </font><font color="#DD0000">"HEAD </font><font color="#007700">{</font><font color="#DD0000">$parts</font><font color="#007700">[</font><font color="#DD0000">'path'</font><font color="#007700">]}{</font><font color="#DD0000">$parts</font><font color="#007700">[</font><font color="#DD0000">'query'</font><font color="#007700">]}</font><font color="#DD0000"> HTTP/1.0</font><font color="#007700">\n</font><font color="#DD0000">"</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">fputs</font><font color="#007700">(</font><font color="#0000BB">$fs</font><font color="#007700">, </font><font color="#DD0000">"Host: </font><font color="#007700">{</font><font color="#DD0000">$parts</font><font color="#007700">[</font><font color="#DD0000">'host'</font><font color="#007700">]}\n</font><font color="#DD0000">"</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">fputs</font><font color="#007700">(</font><font color="#0000BB">$fs</font><font color="#007700">, </font><font color="#DD0000">"User-agent: Webshot v.01 (http://kicken.mine.nu:8008/extras/webshot/ss.php)\n"</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">fputs</font><font color="#007700">(</font><font color="#0000BB">$fs</font><font color="#007700">, </font><font color="#DD0000">"Connection: close\n\n"</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;while (</font><font color="#0000BB">$line</font><font color="#007700">=</font><font color="#0000BB">fgets</font><font color="#007700">(</font><font color="#0000BB">$fs</font><font color="#007700">, </font><font color="#0000BB">2048</font><font color="#007700">)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (</font><font color="#0000BB">preg_match</font><font color="#007700">(</font><font color="#DD0000">'/^HTTP\/1.\d (\d{3})/'</font><font color="#007700">, </font><font color="#0000BB">$line</font><font color="#007700">, </font><font color="#0000BB">$matches</font><font color="#007700">)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (</font><font color="#0000BB">$matches</font><font color="#007700">[</font><font color="#0000BB">1</font><font color="#007700">] != </font><font color="#0000BB">200</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return </font><font color="#0000BB">false</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return </font><font color="#0000BB">true</font><font color="#007700">;<br />}<br /><br />function </font><font color="#0000BB">fixchars</font><font color="#007700">(</font><font color="#0000BB">$str</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;return </font><font color="#0000BB">preg_replace</font><font color="#007700">(</font><font color="#DD0000">'/[^a-zA-Z0-9_]/'</font><font color="#007700">, </font><font color="#DD0000">'_'</font><font color="#007700">, </font><font color="#0000BB">$str</font><font color="#007700">);<br />}<br /><br /></font><font color="#0000BB">$url</font><font color="#007700">=(isset(</font><font color="#0000BB">$_SERVER</font><font color="#007700">[</font><font color="#DD0000">'argv'</font><font color="#007700">][</font><font color="#0000BB">1</font><font color="#007700">]))?</font><font color="#0000BB">$_SERVER</font><font color="#007700">[</font><font color="#DD0000">'argv'</font><font color="#007700">][</font><font color="#0000BB">1</font><font color="#007700">]:(isset(</font><font color="#0000BB">$_GET</font><font color="#007700">[</font><font color="#DD0000">'url'</font><font color="#007700">])?</font><font color="#0000BB">$_GET</font><font color="#007700">[</font><font color="#DD0000">'url'</font><font color="#007700">]:</font><font color="#DD0000">'about:blank'</font><font color="#007700">);<br /><br />if (isset(</font><font color="#0000BB">$_SERVER</font><font color="#007700">[</font><font color="#DD0000">'REMOTE_ADDR'</font><font color="#007700">]) &amp;&amp; </font><font color="#0000BB">$url</font><font color="#007700">==</font><font color="#DD0000">'about:blank'</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;echo &lt;&lt;&lt;EOP<br /></font><font color="#0000BB">&lt;html&gt;<br /> &lt;head&gt;<br />&nbsp;&nbsp;&lt;title&gt;Website Screen Capture&lt;/title&gt;<br /> &lt;/head&gt;<br /> &lt;body&gt;<br />&nbsp;&nbsp;&lt;form action="</font><font color="#007700">{</font><font color="#0000BB">$_SERVER</font><font color="#007700">[</font><font color="#DD0000">'PHP_SELF'</font><font color="#007700">]}</font><font color="#0000BB">" method="get"&gt;<br />&nbsp;&nbsp;&nbsp;What URL would you like to capture? &lt;input type="text" value="" name="url" /&gt;<br />&nbsp;&nbsp;&nbsp;&lt;br /&gt;<br />&nbsp;&nbsp;&nbsp;&lt;input type="submit" value="Get a capture" /&gt;<br />&nbsp;&nbsp;&lt;/form&gt;<br />&nbsp;&nbsp;&lt;p&gt;Or, you can look at all the pages that have &lt;a href='images/'&gt;already been captured&lt;/a&gt;&lt;/p&gt;<br /> &lt;/body&gt;<br />&lt;/html&gt;<br /></font><font color="#007700">EOP;<br />&nbsp;&nbsp;&nbsp;&nbsp;exit;<br />}<br /><br />else if (</font><font color="#0000BB">$url</font><font color="#007700">==</font><font color="#DD0000">'about:blank'</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#DD0000">'You must specify a URL.&nbsp;&nbsp;Please use the format php -q '</font><font color="#007700">.</font><font color="#0000BB">__FILE__</font><font color="#007700">.</font><font color="#DD0000">' &lt;url&gt;'</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#0000BB">chr</font><font color="#007700">(</font><font color="#0000BB">10</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;exit;<br />}<br /><br />if (</font><font color="#0000BB">get_magic_quotes_gpc</font><font color="#007700">()){<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$url</font><font color="#007700">=</font><font color="#0000BB">stripslashes</font><font color="#007700">(</font><font color="#0000BB">$url</font><font color="#007700">);<br />}<br /><br />if (!</font><font color="#0000BB">valid_url</font><font color="#007700">(</font><font color="#0000BB">$url</font><font color="#007700">)){<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#DD0000">'The URL you entered is not one that will be accepted.&nbsp;&nbsp;'</font><font color="#007700">, </font><font color="#0000BB">chr</font><font color="#007700">(</font><font color="#0000BB">10</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#DD0000">'Accepted URL\'s return a 200 status code and contain '</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#DD0000">'data.'</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;exit;<br />}<br /><br />include(</font><font color="#DD0000">'/home/kicken/bin/mysql_connect.php'</font><font color="#007700">);<br /></font><font color="#FF8000">//Check if the URL already exists in the db.<br /></font><font color="#0000BB">$res</font><font color="#007700">=</font><font color="#0000BB">mysql_query</font><font color="#007700">(</font><font color="#DD0000">'SELECT id&nbsp;&nbsp;FORM ss_que WHERE url=\''</font><font color="#007700">.</font><font color="#0000BB">$url</font><font color="#007700">.</font><font color="#DD0000">'\''</font><font color="#007700">);<br />if (!</font><font color="#0000BB">$res </font><font color="#007700">|| </font><font color="#0000BB">mysql_num_rows</font><font color="#007700">(</font><font color="#0000BB">$res</font><font color="#007700">)==</font><font color="#0000BB">0</font><font color="#007700">){<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">mysql_query</font><font color="#007700">(</font><font color="#DD0000">'INSERT INTO ss_que (url) VALUES ("'</font><font color="#007700">.</font><font color="#0000BB">$url</font><font color="#007700">.</font><font color="#DD0000">'")'</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#FF8000">//Find the number of entries before this one.<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$id</font><font color="#007700">=</font><font color="#0000BB">mysql_insert_id</font><font color="#007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$res</font><font color="#007700">=</font><font color="#0000BB">mysql_query</font><font color="#007700">(</font><font color="#DD0000">'SELECT COUNT(ID) FROM ss_que WHERE ID &lt;= "'</font><font color="#007700">.</font><font color="#0000BB">$id</font><font color="#007700">.</font><font color="#DD0000">'"'</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$num</font><font color="#007700">=</font><font color="#0000BB">mysql_result</font><font color="#007700">(</font><font color="#0000BB">$res</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$wait</font><font color="#007700">=</font><font color="#0000BB">$num</font><font color="#007700">*</font><font color="#0000BB">60</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#DD0000">'Your screen shot is '</font><font color="#007700">.</font><font color="#0000BB">$num</font><font color="#007700">.</font><font color="#DD0000">' and should &lt;a href="images/"&gt;be ready&lt;/a&gt; in about '</font><font color="#007700">.</font><font color="#0000BB">$wait</font><font color="#007700">.</font><font color="#DD0000">' seconds.'</font><font color="#007700">;<br />}<br />else {<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$res</font><font color="#007700">=</font><font color="#0000BB">mysql_query</font><font color="#007700">(</font><font color="#DD0000">'SELECT COUNT(ID) FROM ss_que WHERE ID &lt;= "'</font><font color="#007700">.</font><font color="#0000BB">mysql_result</font><font color="#007700">(</font><font color="#0000BB">$res</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">).</font><font color="#DD0000">'"'</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$num</font><font color="#007700">=</font><font color="#0000BB">mysql_result</font><font color="#007700">(</font><font color="#0000BB">$res</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">, </font><font color="#0000BB">0</font><font color="#007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#0000BB">$wait</font><font color="#007700">=</font><font color="#0000BB">$num</font><font color="#007700">*</font><font color="#0000BB">60</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#DD0000">'That URL has already been registered to be snapped.&nbsp;&nbsp;Approximate wait time: '</font><font color="#007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo </font><font color="#0000BB">$wait</font><font color="#007700">.</font><font color="#DD0000">' seconds'</font><font color="#007700">;<br />}<br /><br /></font><font color="#0000BB">?&gt;<br /></font>
</font>
</code>