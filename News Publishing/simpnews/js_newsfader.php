<?php
/***************************************************************************
 * (c)2002-2004 Boesch IT-Consulting (info@boesch-it.de)
 ***************************************************************************/
$path_simpnews=dirname(__FILE__);
$do_db_die=false;
require_once($path_simpnews.'/config.php');
require_once($path_simpnews.'/functions.php');
if(!isset($category))
	$category=0;
if(!isset($$langvar) || !$$langvar)
	$act_lang=$default_lang;
else
	$act_lang=$$langvar;
include($path_simpnews.'/language/lang_'.$act_lang.'.php');
if(!$dbinited)
	die($l_temp_unavail);
include($path_simpnews.'/includes/get_settings.inc');
$index=0;
$actdate = date("Y-m-d 23:59:59");
?>
<style>
a.jsnf { text-decoration: none; color: <?php echo $jsnf_fontcolor?>; }
a.jsnf:hover { text-decoration: underline; }
</style>
<script language="JavaScript1.2">
/*
Output generated by SimpNews V<?php echo $version?> (c)2002-2004 Boesch IT-Consulting
*/

/*
Fading Scroller- By DynamicDrive.com
For full source code, 100's more DHTML scripts, and TOS,
visit http://www.dynamicdrive.com
*/

var delay=<?php echo $jsnf_delay?> //set delay between message change (in miliseconds)
var fcontent=new Array()
begintag='<font face="<?php echo $jsnf_font?>" size="<?php echo $jsnf_fontsize?>" color="<?php echo $jsnf_fontcolor?>">' //set opening tag, such as font declarations
<?php
$announceavail=false;
if(bittst($announceoptions,BIT_8))
{
		$acttime=transposetime(time(),$servertimezone,$displaytimezone);
		$sql = "select * from ".$tableprefix."_announce where (expiredate>=$acttime or expiredate=0)  and (firstdate<=$acttime or firstdate=0)";
		if($jsnf_maxdays>=0)
			$sql.= "and date >= date_sub('$actdate', INTERVAL $jsnf_maxdays DAY) ";
		if($separatebylang==1)
			$sql.="and lang='$act_lang' ";
		if($category>0)
			$sql.= "and (category='$category' or category=0)";
		else if($category==0)
			$sql.= "and category=0";
		$sql.= " order by date desc";
		if(isset($maxannounce))
			$sql.=" limit $maxannounce";
		else if($jsnf_maxentries > 0)
			$sql.=" limit $jsnf_maxentries";
		if(!$result = mysql_query($sql, $db))
		    die("Unable to connect to database.".mysql_error());
		if(mysql_num_rows($result)>0)
		{
			$announceavail=true;
			while($myrow=mysql_fetch_array($result))
			{
				$entrytxt="";
				if($jsnf_nolinking==0)
				{
					if($myrow["tickerurl"])
						$linkdest=$myrow["tickerurl"];
					else
						$linkdest="http://".$simpnewssitename.$url_simpnews."/announce.php?announcenr=".$myrow["entrynr"]."&$langvar=$act_lang&layout=$layout&category=".$myrow["category"];
					$entrytxt.="<a class=\"jsnf\" href=\"$linkdest\"";
					$entrytxt.=" target=\"$jsnf_linktarget\">";
				}
				if($jsnf_displaydate)
				{
					list($mydate,$mytime)=explode(" ",$myrow["date"]);
					list($year, $month, $day) = explode("-", $mydate);
					list($hour, $min, $sec) = explode(":",$mytime);
					if($month>0)
					{
						$displaytime=mktime($hour,$min,$sec,$month,$day,$year);
						$displaytime=transposetime($displaytime,$servertimezone,$displaytimezone);
						$displaydate=date($jsnf_dateformat,$displaytime);
						$entrytxt.=$displaydate;
						if($myrow["category"]==0)
							$entrytxt.="(".$l_global_announcement.")";
						else
							$entrytxt.="(".$l_announcement.")";
						$entrytxt.="<br>";
					}
				}
				if($myrow["heading"])
					$entrytxt.=undo_htmlentities(stripslashes($myrow["heading"]))."<br>";
				$displaytext = undo_htmlspecialchars(stripslashes($myrow["text"]));
				$displaytext = str_replace("\r","",$displaytext);
				$displaytext = undo_htmlentities($displaytext);
				$displaytext = strip_tags($displaytext);
				if(($jsnf_maxchars>0) && (strlen($displaytext)>$jsnf_maxchars))
				{
					$text = explode(" ", $displaytext);
					$i = 0;
					$length = 0;
					$displaytext="";
					while(($i<count($text)) && ($length<$jsnf_maxchars))
					{
						$length+=strlen($text[$i]);
						if($length<=$jsnf_maxchars)
						{
							$displaytext.=$text[$i]." ";
							$i++;
						}
					}
					if($i<count($text))
						$displaytext.="...";
				}
				if($jsnf_maxchars!=0)
					$entrytxt.=$displaytext;
				if($jsnf_nolinking==0)
					$entrytxt.="</a>";
				$entrytxt = str_replace("\"","\\\"",$entrytxt);
				echo "fcontent[$index]=\"$entrytxt\";\n";
				$index++;
			}
		}
}
$sql = "select * from ".$tableprefix."_data ";
if($category>=0)
	$sql.= "where category='$category' ";
else
{
	$sql.="where linknewsnr=0 ";
	$tmpsql="select * from ".$tableprefix."_categories where hideintotallist=1";
	if(!$tmpresult = mysql_query($tmpsql, $db))
	    die("Unable to connect to database.".mysql_error());
	while($tmprow=mysql_fetch_array($tmpresult))
		$sql.="and category!=".$tmprow["catnr"]." ";
}
if($separatebylang==1)
	$sql.="and lang='$act_lang' ";
if($jsnf_maxdays>=0)
	$sql.= "and date >= date_sub('$actdate', INTERVAL $jsnf_maxdays DAY) ";
if($showfuturenews==0)
	$sql.="and date<='$actdate' ";
$sql.="order by date desc";
if($jsnf_maxentries > 0)
	$sql.=" limit $jsnf_maxentries";
if(!$result = mysql_query($sql, $db))
    die();
if(mysql_num_rows($result)>0)
{
	while($myrow=mysql_fetch_array($result))
	{
		if($myrow["linknewsnr"]==0)
			$entrydata=$myrow;
		else
		{
			$tmpsql="select * from ".$tableprefix."_data where newsnr=".$myrow["linknewsnr"];
			if(!$tmpresult = mysql_query($tmpsql, $db))
				die("<tr class=\"errorrow\"><td>Unable to connect to database.".mysql_error());
			if(!$tmprow=mysql_fetch_array($tmpresult))
				die("<tr class=\"errorrow\"><td>Unable to connect to database.".mysql_error());
			$entrydata=$tmprow;
		}
		$entrytxt="";
		if($jsnf_nolinking==0)
		{
			if($entrydata["tickerurl"])
				$entrytxt.="<a class=\"jsnf\" href=\"".$entrydata["tickerurl"]."\"";
			else
			{
				$srcscript=$url_simpnews."/news.php";
				if($usejslinkdest==1)
					$linkdest="$jslinkdest?newsnr=".$entrydata["newsnr"]."&$langvar=$act_lang&layout=$layout&category=".$entrydata["category"]."&srcscript=$srcscript";
				else
					$linkdest="http://".$simpnewssitename.$url_simpnews."/singlenews.php?newsnr=".$entrydata["newsnr"]."&$langvar=$act_lang&layout=$layout&category=".$entrydata["category"]."&srcscript=$srcscript";
				$entrytxt.="<a class=\"jsnf\" href=\"$linkdest\"";
			}
			$entrytxt.=" target=\"$jsnf_linktarget\">";
		}
		if($jsnf_displaydate)
		{
			list($mydate,$mytime)=explode(" ",$myrow["date"]);
			list($year, $month, $day) = explode("-", $mydate);
			list($hour, $min, $sec) = explode(":",$mytime);
			if($month>0)
			{
				$displaytime=mktime($hour,$min,$sec,$month,$day,$year);
				$displaytime=transposetime($displaytime,$servertimezone,$displaytimezone);
				$displaydate=date($jsnf_dateformat,$displaytime);
				$entrytxt.=$displaydate."<br>";
			}
		}
		if($entrydata["heading"])
			$entrytxt.=undo_htmlentities(stripslashes($entrydata["heading"]))."<br>";
		$displaytext = undo_htmlspecialchars(stripslashes($entrydata["text"]));
		$displaytext = str_replace("\r","",$displaytext);
		$displaytext = undo_htmlentities($displaytext);
		$displaytext = strip_tags($displaytext);
		if(($jsnf_maxchars>0) && (strlen($displaytext)>$jsnf_maxchars))
		{
			$text = explode(" ", $displaytext);
			$i = 0;
			$length = 0;
			$displaytext="";
			while(($i<count($text)) && ($length<$jsnf_maxchars))
			{
				$length+=strlen($text[$i]);
				if($length<=$jsnf_maxchars)
				{
					$displaytext.=$text[$i]." ";
					$i++;
				}
			}
			if($i<count($text))
				$displaytext.="...";
		}
		if($jsnf_maxchars!=0)
			$entrytxt.=$displaytext;
		if($jsnf_nolinking==0)
			$entrytxt.="</a>";
		$entrytxt = str_replace("\"","\\\"",$entrytxt);
		echo "fcontent[$index]=\"$entrytxt\";\n";
		$index++;
	}
}
else if(!$announceavail)
{
	$entrytxt="";
	if($jsnf_nolinking==0)
		$entrytxt.="<a class=\"jsnf\" href=\"http://".$simpnewssitename.$url_simpnews."/news.php?$langvar=$act_lang&layout=$layout&category=$category\" target=\"$jsnf_linktarget\">";
	$entrytxt.=$l_nonewnews;
	if($jsnf_nolinking==0)
		$entrytxt.="</a>";
	$entrytxt = str_replace("\"","\\\"",$entrytxt);
	echo "fcontent[$index]=\"$entrytxt\";\n";
}
?>
closetag='</font>'

var fwidth=<?php echo $jsnf_width?> //set scroller width
var fheight=<?php echo $jsnf_height?> //set scroller height

///No need to edit below this line/////////////////

var ie4=document.all&&!document.getElementById
var ns4=document.layers
var DOM2=document.getElementById
var faderdelay=0
var index=0

if (DOM2)
faderdelay=2000

//function to change content
function changecontent(){
if (index>=fcontent.length)
index=0
if (DOM2){
document.getElementById("fscroller").style.color="rgb(255,255,255)"
document.getElementById("fscroller").innerHTML=begintag+fcontent[index]+closetag
colorfade()
}
else if (ie4)
document.all.fscroller.innerHTML=begintag+fcontent[index]+closetag
else if (ns4){
document.fscrollerns.document.fscrollerns_sub.document.write(begintag+fcontent[index]+closetag)
document.fscrollerns.document.fscrollerns_sub.document.close()
}

index++
setTimeout("changecontent()",delay+faderdelay)
}

// colorfade() partially by Marcio Galli for Netscape Communications.  ////////////
// Modified by Dynamicdrive.com

frame=20;
hex=255  // Initial color value.

function colorfade() {
// 20 frames fading process
if(frame>0) {
hex-=12; // increase color value
document.getElementById("fscroller").style.color="rgb("+hex+","+hex+","+hex+")"; // Set color value.
frame--;
setTimeout("colorfade()",20);
}
else{
document.getElementById("fscroller").style.color="rgb(0,0,0)";
frame=20;
hex=255
}
}

if (ie4||DOM2)
document.write('<div id="fscroller" style="border:1px solid black;width:'+fwidth+';height:'+fheight+';padding:2px"></div>')

window.onload=changecontent
</script>
<ilayer id="fscrollerns" width=&{fwidth}; height=&{fheight};><layer id="fscrollerns_sub" width=&{fwidth}; height=&{fheight}; left=0 top=0></layer></ilayer>
